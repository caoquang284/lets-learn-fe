<div class="meeting-room-container">
  <!-- Loading Screen -->
  <div class="loading-screen" *ngIf="isLoadingToken || connectionState.isConnecting">
    <div class="loading-card">
      <div class="spinner"></div>
      <h2>Connecting to meeting...</h2>
      <p>Please wait while we prepare your room</p>
    </div>
  </div>

  <!-- Error Screen -->
  <div class="error-screen" *ngIf="!isLoadingToken && !connectionState.isConnecting && !connectionState.isConnected && connectionState.error">
    <div class="error-card">
      <span class="material-symbols-outlined error-icon">error</span>
      <h2>Unable to Join Meeting</h2>
      <p class="error-message">{{ connectionState.error }}</p>
      <button class="retry-btn" (click)="fetchTokenFromBackend()">
        <span class="material-symbols-outlined">refresh</span>
        Try Again
      </button>
      <button class="back-btn" (click)="leaveRoom()">
        <span class="material-symbols-outlined">arrow_back</span>
        Back to Meeting
      </button>
    </div>
  </div>

  <!-- Meeting Room -->
  <div class="meeting-room" *ngIf="connectionState.isConnected">
    <!-- Reactions Display -->
    <div class="reactions-container">
      <div 
        *ngFor="let reaction of reactions"
        class="reaction-animation"
        [style.left.%]="reaction.x"
        [style.top.%]="reaction.y"
      >
        {{ reaction.emoji }}
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content" [class.sidebar-open]="showMeetingDetails || showParticipants || showChat">
      <!-- Video Container -->
      <div class="video-area">
        <div class="video-container">
          <!-- Local Video -->
          <div class="video-tile local-video" [class.speaking]="isLocalSpeaking">
            <video #localVideo autoplay playsinline muted [class.hidden]="!isVideoEnabled"></video>
            <div class="avatar-placeholder" *ngIf="!isVideoEnabled">
              <div class="avatar-circle">
                <span class="avatar-initial">{{ getInitial(currentUserIdentity) }}</span>
          </div>
        </div>
        <audio #localAudio autoplay></audio>
        <div class="raised-hand-indicator" *ngIf="isHandRaised">
          <span class="material-icons">pan_tool</span>
        </div>
        <div class="video-label">You (Local)</div>
      </div>          <!-- Remote Participants -->
          <div 
            class="video-tile remote-video" 
            [class.speaking]="isParticipantSpeaking(participant.identity)"
            *ngFor="let participant of connectionState.remoteParticipants"
          >
            <video 
              [id]="'remote-video-' + participant.identity" 
              autoplay 
              playsinline
              [class.hidden]="!isParticipantVideoEnabled(participant)"
            ></video>
            <div class="avatar-placeholder" *ngIf="!isParticipantVideoEnabled(participant)">
              <div class="avatar-circle">
                <span class="avatar-initial">{{ getInitial(participant.identity) }}</span>
              </div>
            </div>
            <audio 
              [id]="'remote-audio-' + participant.identity" 
              autoplay
            ></audio>
            <div class="raised-hand-indicator" *ngIf="isHandRaisedFor(participant.identity)">
              <span class="material-icons">pan_tool</span>
            </div>
            <div class="video-label">{{ getParticipantDisplayName(participant.identity) }}</div>
          </div>
        </div> <!-- End video-container -->
      </div> <!-- End video-area -->

      <!-- Sidebar Panels -->
      <div class="sidebar-panel" *ngIf="showMeetingDetails || showParticipants || showChat">
        <!-- Meeting Details Panel -->
        <div class="panel-content" *ngIf="showMeetingDetails">
          <div class="panel-header">
            <h3>Meeting Details</h3>
            <button class="close-panel" (click)="toggleMeetingDetails()">
              <span class="material-icons">close</span>
            </button>
          </div>
          <div class="panel-body">
            <div class="detail-item">
              <span class="detail-label">Room Name</span>
              <span class="detail-value">{{ roomName }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Meeting Time</span>
              <span class="detail-value">{{ currentTime }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Participants</span>
              <span class="detail-value">{{ connectionState.remoteParticipants.length + 1 }}</span>
            </div>
          </div>
        </div>

        <!-- Participants Panel -->
        <div class="panel-content" *ngIf="showParticipants">
          <div class="panel-header">
            <h3>Participants ({{ connectionState.remoteParticipants.length + 1 }})</h3>
            <button class="close-panel" (click)="toggleParticipants()">
              <span class="material-icons">close</span>
            </button>
          </div>
          <div class="panel-body">
            <!-- Local Participant -->
            <div class="participant-item">
              <div class="participant-avatar">
                <span class="avatar-text">{{ getInitial(currentUserIdentity) }}</span>
              </div>
              <div class="participant-info">
                <span class="participant-name">You</span>
                <span class="participant-role">Host</span>
              </div>
              <div class="participant-status">
                <span class="material-icons" [class.muted]="!isAudioEnabled">
                  {{ isAudioEnabled ? 'mic' : 'mic_off' }}
                </span>
                <span class="material-icons" [class.muted]="!isVideoEnabled">
                  {{ isVideoEnabled ? 'videocam' : 'videocam_off' }}
                </span>
              </div>
            </div>

            <!-- Remote Participants -->
            <div class="participant-item" *ngFor="let participant of connectionState.remoteParticipants">
              <div class="participant-avatar">
                <span class="avatar-text">{{ getInitial(participant.identity) }}</span>
              </div>
              <div class="participant-info">
                <span class="participant-name">{{ getParticipantDisplayName(participant.identity) }}</span>
                <span class="participant-role">Participant</span>
              </div>
              <div class="participant-status">
                <span class="material-icons">mic</span>
                <span class="material-icons" [class.muted]="!isParticipantVideoEnabled(participant)">
                  {{ isParticipantVideoEnabled(participant) ? 'videocam' : 'videocam_off' }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Panel -->
        <div class="panel-content" *ngIf="showChat">
          <div class="panel-header">
            <h3>Chat</h3>
            <button class="close-panel" (click)="toggleChat()">
              <span class="material-icons">close</span>
            </button>
          </div>
          <div class="panel-body chat-body">
            <div class="chat-messages" #chatMessagesContainer>
              <p class="chat-empty" *ngIf="chatMessages.length === 0">No messages yet. Start the conversation!</p>
              <div class="chat-message" *ngFor="let message of chatMessages" [class.own-message]="message.senderId === currentUserIdentity">
                <div class="message-header">
                  <span class="message-sender">{{ message.senderName }}</span>
                  <span class="message-time">{{ message.timestamp | date:'shortTime' }}</span>
                </div>
                <div class="message-text">{{ message.text }}</div>
              </div>
            </div>
            <div class="chat-input-container">
              <input 
                type="text" 
                class="chat-input" 
                placeholder="Type a message..."
                [(ngModel)]="chatInputText"
                (keyup.enter)="sendChatMessage()"
              >
              <button class="send-btn" (click)="sendChatMessage()" [disabled]="!chatInputText.trim()">
                <span class="material-icons">send</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Whiteboard Modal -->
    <div class="whiteboard-modal" *ngIf="showWhiteboard">
      <div class="whiteboard-header">
        <h2>Collaborative Whiteboard</h2>
        <button class="close-whiteboard" (click)="toggleWhiteboard()" title="Close Whiteboard">
          √ó
        </button>
      </div>
      <app-whiteboard 
        #whiteboard
        [currentUser]="currentUserIdentity"
        (onAction)="onWhiteboardAction($event)">
      </app-whiteboard>
    </div>

    <!-- Controls -->
    <div class="controls-bar">
      <div class="left-controls">
        <span class="meeting-time">{{ currentTime }} | {{ roomName }}</span>
      </div>

      <div class="center-controls">
        <button 
          class="control-btn" 
          [class.disabled]="!isAudioEnabled"
          (click)="toggleAudio()"
          title="Toggle Microphone"
        >
          <span class="material-icons" *ngIf="isAudioEnabled">mic</span>
          <span class="material-icons" *ngIf="!isAudioEnabled">mic_off</span>
        </button>

        <button 
          class="control-btn" 
          [class.disabled]="!isVideoEnabled"
          (click)="toggleVideo()"
          title="Toggle Camera"
        >
          <span class="material-icons" *ngIf="isVideoEnabled">videocam</span>
          <span class="material-icons" *ngIf="!isVideoEnabled">videocam_off</span>
        </button>

        <button 
          class="control-btn"
          title="Share Screen"
        >
          <span class="material-icons">present_to_all</span>
        </button>

        <button 
          class="control-btn"
          title="Record"
        >
          <span class="material-icons">fiber_manual_record</span>
        </button>

        <button 
          class="control-btn" 
          (click)="toggleWhiteboard()"
          [class.active]="showWhiteboard"
          title="Open Whiteboard"
        >
          <span class="material-icons">dashboard</span>
        </button>

        <button 
          class="control-btn"
          (click)="toggleReactionPicker()"
          [class.active]="showReactionPicker"
          title="React"
        >
          <span class="material-icons">add_reaction</span>
        </button>

        <!-- Reaction Picker Popup -->
        <div class="reaction-picker" *ngIf="showReactionPicker">
          <button class="reaction-emoji" (click)="sendReaction('üëç')">üëç</button>
          <button class="reaction-emoji" (click)="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
          <button class="reaction-emoji" (click)="sendReaction('üòÇ')">üòÇ</button>
          <button class="reaction-emoji" (click)="sendReaction('üòÆ')">üòÆ</button>
          <button class="reaction-emoji" (click)="sendReaction('üò¢')">üò¢</button>
          <button class="reaction-emoji" (click)="sendReaction('üëè')">üëè</button>
          <button class="reaction-emoji" (click)="sendReaction('üéâ')">üéâ</button>
          <button class="reaction-emoji" (click)="sendReaction('üî•')">üî•</button>
        </div>

        <button 
          class="control-btn"
          (click)="toggleRaiseHand()"
          [class.active]="isHandRaised"
          title="Raise Hand"
        >
          <span class="material-icons">pan_tool</span>
        </button>

        <button 
          class="control-btn leave-btn" 
          (click)="leaveRoom()"
          title="Leave Meeting"
        >
          <span class="material-icons">call_end</span>
        </button>
      </div>

      <div class="right-controls">
        <button 
          class="control-btn info-btn"
          (click)="toggleMeetingDetails()"
          [class.active]="showMeetingDetails"
          title="Meeting Details"
        >
          <span class="material-icons">info</span>
        </button>

        <button 
          class="control-btn participants-btn"
          (click)="toggleParticipants()"
          [class.active]="showParticipants"
          title="Show Participants"
        >
          <span class="material-icons">group</span>
          <span class="participant-count">{{ connectionState.remoteParticipants.length + 1 }}</span>
        </button>

        <button 
          class="control-btn chat-btn"
          (click)="toggleChat()"
          [class.active]="showChat"
          title="Chat"
        >
          <span class="material-icons">chat</span>
        </button>
      </div>
    </div>
  </div>
</div>