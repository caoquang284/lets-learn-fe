<div class="meeting-room" [class.sidebar-open]="isChatOpen || isParticipantsOpen"  >
  <div class="stage" [class.screen-share]="isScreenSharing" [class.alone]="isAlone">
    <!-- Khi chỉ có mình bạn: hiển thị 1 tile của chính bạn -->
    <div class="self-tile" *ngIf="isAlone; else grid">
      <div class="video-placeholder" [class.speaking]="isSpeaking">
        <video #selfVideo *ngIf="isCameraOn" autoplay playsinline muted></video>
        <div *ngIf="!isCameraOn" class="avatar" [style.background-color]="self.color"></div>
        <div class="name">{{ self.name }}</div>
      </div>
    </div>
    <!-- Khi có người khác: vẫn dùng grid -->
    <ng-template #grid>
      <div class="videos-grid">
        <div class="video-placeholder" *ngFor="let participant of participants" [class.speaking]="participant.name === self.name && isSpeaking">
          <!-- Nếu là chính bạn: ưu tiên hiển thị video khi bật cam; nếu tắt cam -> avatar -->
          <ng-container *ngIf="participant.name === self.name; else othersAvatar">
            <video #selfVideo *ngIf="isCameraOn" autoplay playsinline muted></video>
            <div *ngIf="!isCameraOn" class="avatar" [style.background-color]="participant.color"></div>
          </ng-container>
          <ng-template #othersAvatar>
            <div class="avatar" [style.background-color]="participant.color"></div>
          </ng-template>
          <div class="name">{{ participant.name }}</div>
        </div>
      </div>
    </ng-template>
    <div class="screen-share-placeholder" *ngIf="isScreenSharing">
      <video #screenVideo autoplay playsinline class="screen-video"></video>
      <div class="screen-share-label">You are sharing your screen</div>
    </div>
  </div>

  <div class="controls">
    <button class="control" (click)="toggleMic()">
      <svg *ngIf="isMicOn" class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <rect x="9" y="3" width="6" height="10" rx="3"/>
        <path d="M5 10a7 7 0 0 0 14 0"/>
        <path d="M12 20v-3"/>
      </svg>
      <svg *ngIf="!isMicOn" class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <rect x="9" y="3" width="6" height="10" rx="3"/>
        <path d="M5 10a7 7 0 0 0 14 0"/>
        <path d="M12 20v-3"/>
        <path d="M4 4l16 16"/>
      </svg>
      <span class="label">Microphone</span>
      <span class="caret">▾</span>
    </button>

    <button class="control" (click)="toggleCam()">
      <svg *ngIf="isCameraOn" class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <rect x="3" y="6" width="12" height="10" rx="2"/>
        <path d="M21 8l-4 3v2l4 3z"/>
      </svg>
      <svg *ngIf="!isCameraOn" class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <rect x="3" y="6" width="12" height="10" rx="2"/>
        <path d="M21 8l-4 3v2l4 3z"/>
        <path d="M4 4l16 16"/>
      </svg>
      <span class="label">Camera</span>
      <span class="caret">▾</span>
    </button>

    <button class="control share" (click)="shareScreen()">
      <svg class="icon icon-lg" viewBox="0 0 24 24" aria-hidden="true">
        <rect x="3" y="4" width="18" height="12" rx="2"/>
        <path d="M12 14V8"/>
        <path d="M9 11l3-3 3 3"/>
      </svg>
      <span class="label">Share screen</span>
    </button>

    <button class="control" (click)="openWhiteboard()">
      <svg class="icon icon-lg" viewBox="0 0 24 24" aria-hidden="true">
        <rect x="3" y="5" width="18" height="12" rx="2"/>
        <path d="M8 13l3-3 5 5"/>
        <path d="M7 14l1 1"/>
      </svg>
      <span class="label">Whiteboard</span>
    </button>

    <button class="control chat" [class.active]="isChatOpen" (click)="toggleChat()">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 5h16v10H8l-4 4z"/>
      </svg>
      <span class="label">Chat</span>
    </button>

    <button class="control participants" [class.active]="isParticipantsOpen" (click)="toggleParticipants()">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <circle cx="8" cy="9" r="3"/>
        <circle cx="16" cy="9" r="3"/>
        <path d="M2 20a6 6 0 0 1 12 0"/>
        <path d="M10 20a6 6 0 0 1 12 0"/>
      </svg>
      <span class="label">Participants</span>
    </button>

    <button class="control more" [matMenuTriggerFor]="moreMenu">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <circle cx="6" cy="12" r="1.5"/>
        <circle cx="12" cy="12" r="1.5"/>
        <circle cx="18" cy="12" r="1.5"/>
      </svg>
      <span class="label">More</span>
    </button>
    <mat-menu #moreMenu="matMenu">
      <button mat-menu-item>Record meeting</button>
      <button mat-menu-item>Reactions</button>
    </mat-menu>

    <button class="control leave" (click)="leave()">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M10 17l5-5-5-5"/>
        <path d="M4 12h11"/>
        <path d="M19 5v14"/>
      </svg>
      <span class="label">Leave</span>
    </button>
  </div>

  <div class="sidebar" *ngIf="isChatOpen || isParticipantsOpen">
    <div class="sidebar-header">
      <div class="sidebar-tabs">
        <button [class.active]="isChatOpen" (click)="toggleChat(true)">Chat</button>
        <button [class.active]="isParticipantsOpen" (click)="toggleParticipants(true)">Participants ({{ participants.length }})</button>
      </div>
      <button class="sidebar-close" (click)="closeSidebar()" aria-label="Close sidebar">×</button>
    </div>

    <div class="chat-content" *ngIf="isChatOpen">
      <div class="messages">
        <div class="message" *ngFor="let m of messages">
          <span class="sender">{{ m.sender }}:</span> {{ m.text }} <span class="time">{{ m.time }}</span>
        </div>
      </div>
      <div class="composer">
        <input type="text" placeholder="Enter a message" [(ngModel)]="draft" (keyup.enter)="send()">
        <button (click)="send()">Send</button>
      </div>
    </div>

    <div class="participants-content" *ngIf="isParticipantsOpen">
      <input type="text" placeholder="Search participants" class="search-input">
      <div class="participant" *ngFor="let p of participants">
        <div class="avatar small" [style.background-color]="p.color"></div>
        <span class="name">{{ p.name }}</span>
        <span class="role">{{ p.role }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Whiteboard Modal -->
<div class="whiteboard-modal" *ngIf="isWhiteboardOpen">
  <div class="whiteboard-header">
    <h2>Whiteboard</h2>
    <button class="close-whiteboard" (click)="openWhiteboard()" aria-label="Close whiteboard">×</button>
  </div>
  <app-whiteboard 
    [currentUser]="currentUser"
    (onAction)="onWhiteboardAction($event)">
  </app-whiteboard>
</div>