<div class="meeting-room-container">
  <!-- Loading Screen -->
  <div class="loading-screen" *ngIf="isLoadingToken || connectionState.isConnecting">
    <div class="loading-card">
      <div class="spinner"></div>
      <h2>Connecting to meeting...</h2>
      <p>Please wait while we prepare your room</p>
    </div>
  </div>

  <!-- Error Screen -->
  <div class="error-screen" *ngIf="!isLoadingToken && !connectionState.isConnecting && !connectionState.isConnected && connectionState.error">
    <div class="error-card">
      <span class="material-symbols-outlined error-icon">error</span>
      <h2>Unable to Join Meeting</h2>
      <p class="error-message">{{ connectionState.error }}</p>
      <button class="retry-btn" (click)="fetchTokenFromBackend()">
        <span class="material-symbols-outlined">refresh</span>
        Try Again
      </button>
      <button class="back-btn" (click)="leaveRoom()">
        <span class="material-symbols-outlined">arrow_back</span>
        Back to Meeting
      </button>
    </div>
  </div>

  <!-- Meeting Room -->
  <div class="meeting-room" *ngIf="connectionState.isConnected">
    <div class="video-container">
      <!-- Local Video -->
      <div class="video-tile local-video">
        <video #localVideo autoplay playsinline muted></video>
        <audio #localAudio autoplay></audio>
        <div class="video-label">You (Local)</div>
      </div>

      <!-- Remote Participants -->
      <div 
        class="video-tile remote-video" 
        *ngFor="let participant of connectionState.remoteParticipants"
      >
        <video 
          [id]="'remote-video-' + participant.identity" 
          autoplay 
          playsinline
        ></video>
        <audio 
          [id]="'remote-audio-' + participant.identity" 
          autoplay
        ></audio>
        <div class="video-label">{{ getParticipantDisplayName(participant.identity) }}</div>
      </div>

      <!-- No Remote Participants Message -->
      <div class="no-participants" *ngIf="connectionState.remoteParticipants.length === 0">
        <div class="waiting-message">
          <span class="material-symbols-outlined">group</span>
          <p>Waiting for others to join...</p>
          <p class="sub">Share the room name: <strong>{{ roomName }}</strong></p>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls-bar">
      <div class="controls-group">
        <button 
          class="control-btn" 
          [class.disabled]="!isAudioEnabled"
          (click)="toggleAudio()"
          title="Toggle Microphone"
        >
          <span class="material-symbols-outlined">
            {{ isAudioEnabled ? 'mic' : 'mic_off' }}
          </span>
        </button>

        <button 
          class="control-btn" 
          [class.disabled]="!isVideoEnabled"
          (click)="toggleVideo()"
          title="Toggle Camera"
        >
          <span class="material-symbols-outlined">
            {{ isVideoEnabled ? 'videocam' : 'videocam_off' }}
          </span>
        </button>

        <button 
          class="control-btn leave-btn" 
          (click)="leaveRoom()"
          title="Leave Meeting"
        >
          <span class="material-symbols-outlined">call_end</span>
        </button>
      </div>

      <div class="room-info">
        Room: <strong>{{ roomName }}</strong> | 
        Participants: <strong>{{ connectionState.remoteParticipants.length + 1 }}</strong>
      </div>
    </div>
  </div>
</div>