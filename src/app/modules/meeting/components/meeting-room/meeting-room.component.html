<div class="meeting-room-container">
  <!-- Loading Screen -->
  <div class="loading-screen" *ngIf="isLoadingToken || connectionState.isConnecting">
    <div class="loading-card">
      <div class="spinner"></div>
      <h2>Connecting to meeting...</h2>
      <p>Please wait while we prepare your room</p>
    </div>
  </div>

  <!-- Error Screen -->
  <div class="error-screen" *ngIf="!isLoadingToken && !connectionState.isConnecting && !connectionState.isConnected && connectionState.error">
    <div class="error-card">
      <span class="material-symbols-outlined error-icon">error</span>
      <h2>Unable to Join Meeting</h2>
      <p class="error-message">{{ connectionState.error }}</p>
      <button class="retry-btn" (click)="fetchTokenFromBackend()">
        <span class="material-symbols-outlined">refresh</span>
        Try Again
      </button>
      <button class="back-btn" (click)="leaveRoom()">
        <span class="material-symbols-outlined">arrow_back</span>
        Back to Meeting
      </button>
    </div>
  </div>

  <!-- Meeting Room -->
  <div class="meeting-room" *ngIf="connectionState.isConnected">
    <!-- Reactions Display -->
    <div class="reactions-container">
      <div 
        *ngFor="let reaction of reactions"
        class="reaction-animation"
        [style.left.%]="reaction.x"
        [style.top.%]="reaction.y"
      >
        {{ reaction.emoji }}
      </div>
    </div>

    <!-- Whiteboard Modal -->
    <div class="whiteboard-modal" *ngIf="showWhiteboard">
      <div class="whiteboard-header">
        <h2>Collaborative Whiteboard</h2>
        <button class="close-whiteboard" (click)="toggleWhiteboard()" title="Close Whiteboard">
          Ã—
        </button>
      </div>
      <app-whiteboard 
        #whiteboard
        [currentUser]="currentUserIdentity"
        (onAction)="onWhiteboardAction($event)">
      </app-whiteboard>
    </div>

    <div class="video-container">
      <!-- Local Video -->
      <div class="video-tile local-video">
        <video #localVideo autoplay playsinline muted [class.hidden]="!isVideoEnabled"></video>
        <div class="avatar-placeholder" *ngIf="!isVideoEnabled">
          <div class="avatar-circle">
            <span class="avatar-initial">{{ getInitial(currentUserIdentity) }}</span>
          </div>
        </div>
        <audio #localAudio autoplay></audio>
        <div class="video-label">You (Local)</div>
      </div>

      <!-- Remote Participants -->
      <div 
        class="video-tile remote-video" 
        *ngFor="let participant of connectionState.remoteParticipants"
      >
        <video 
          [id]="'remote-video-' + participant.identity" 
          autoplay 
          playsinline
          [class.hidden]="!isParticipantVideoEnabled(participant)"
        ></video>
        <div class="avatar-placeholder" *ngIf="!isParticipantVideoEnabled(participant)">
          <div class="avatar-circle">
            <span class="avatar-initial">{{ getInitial(participant.identity) }}</span>
          </div>
        </div>
        <audio 
          [id]="'remote-audio-' + participant.identity" 
          autoplay
        ></audio>
        <div class="video-label">{{ getParticipantDisplayName(participant.identity) }}</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls-bar">
      <div class="left-controls">
        <span class="meeting-time">{{ currentTime }} | {{ roomName }}</span>
      </div>

      <div class="center-controls">
        <button 
          class="control-btn" 
          [class.disabled]="!isAudioEnabled"
          (click)="toggleAudio()"
          title="Toggle Microphone"
        >
          <span class="material-icons" *ngIf="isAudioEnabled">mic</span>
          <span class="material-icons" *ngIf="!isAudioEnabled">mic_off</span>
        </button>

        <button 
          class="control-btn" 
          [class.disabled]="!isVideoEnabled"
          (click)="toggleVideo()"
          title="Toggle Camera"
        >
          <span class="material-icons" *ngIf="isVideoEnabled">videocam</span>
          <span class="material-icons" *ngIf="!isVideoEnabled">videocam_off</span>
        </button>

        <button 
          class="control-btn"
          title="Share Screen"
        >
          <span class="material-icons">present_to_all</span>
        </button>

        <button 
          class="control-btn"
          title="Record"
        >
          <span class="material-icons">fiber_manual_record</span>
        </button>

        <button 
          class="control-btn" 
          (click)="toggleWhiteboard()"
          [class.active]="showWhiteboard"
          title="Open Whiteboard"
        >
          <span class="material-icons">dashboard</span>
        </button>

        <button 
          class="control-btn"
          (click)="toggleReactionPicker()"
          [class.active]="showReactionPicker"
          title="React"
        >
          <span class="material-icons">add_reaction</span>
        </button>

        <!-- Reaction Picker Popup -->
        <div class="reaction-picker" *ngIf="showReactionPicker">
          <button class="reaction-emoji" (click)="sendReaction('ğŸ‘')">ğŸ‘</button>
          <button class="reaction-emoji" (click)="sendReaction('â¤ï¸')">â¤ï¸</button>
          <button class="reaction-emoji" (click)="sendReaction('ğŸ˜‚')">ğŸ˜‚</button>
          <button class="reaction-emoji" (click)="sendReaction('ğŸ˜®')">ğŸ˜®</button>
          <button class="reaction-emoji" (click)="sendReaction('ğŸ˜¢')">ğŸ˜¢</button>
          <button class="reaction-emoji" (click)="sendReaction('ğŸ‘')">ğŸ‘</button>
          <button class="reaction-emoji" (click)="sendReaction('ğŸ‰')">ğŸ‰</button>
          <button class="reaction-emoji" (click)="sendReaction('ğŸ”¥')">ğŸ”¥</button>
        </div>

        <button 
          class="control-btn"
          title="Raise Hand"
        >
          <span class="material-icons">pan_tool</span>
        </button>

        <button 
          class="control-btn leave-btn" 
          (click)="leaveRoom()"
          title="Leave Meeting"
        >
          <span class="material-icons">call_end</span>
        </button>
      </div>

      <div class="right-controls">
        <button 
          class="control-btn info-btn"
          title="Meeting Details"
        >
          <span class="material-icons">info</span>
        </button>

        <button 
          class="control-btn participants-btn"
          title="Show Participants"
        >
          <span class="material-icons">group</span>
          <span class="participant-count">{{ connectionState.remoteParticipants.length + 1 }}</span>
        </button>

        <button 
          class="control-btn chat-btn"
          title="Chat"
        >
          <span class="material-icons">chat</span>
        </button>
      </div>
    </div>
  </div>
</div>