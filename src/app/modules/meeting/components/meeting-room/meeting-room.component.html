<div class="meeting-room-container">
  <!-- Loading Screen -->
  <div class="loading-screen" *ngIf="isLoadingToken || connectionState.isConnecting">
    <div class="loading-card">
      <div class="spinner"></div>
      <h2>Connecting to meeting...</h2>
      <p>Please wait while we prepare your room</p>
    </div>
  </div>

  <!-- Error Screen -->
  <div class="error-screen" *ngIf="!isLoadingToken && !connectionState.isConnecting && !connectionState.isConnected && connectionState.error">
    <div class="error-card">
      <span class="material-symbols-outlined error-icon">error</span>
      <h2>Unable to Join Meeting</h2>
      <p class="error-message">{{ connectionState.error }}</p>
      <button class="retry-btn" (click)="fetchTokenFromBackend()">
        <span class="material-symbols-outlined">refresh</span>
        Try Again
      </button>
      <button class="back-btn" (click)="leaveRoom()">
        <span class="material-symbols-outlined">arrow_back</span>
        Back to Meeting
      </button>
    </div>
  </div>

  <!-- Meeting Room -->
  <div class="meeting-room" *ngIf="connectionState.isConnected">
    <!-- Whiteboard Modal -->
    <div class="whiteboard-modal" *ngIf="showWhiteboard">
      <div class="whiteboard-header">
        <h2>Collaborative Whiteboard</h2>
        <button class="close-whiteboard" (click)="toggleWhiteboard()" title="Close Whiteboard">
          Ã—
        </button>
      </div>
      <app-whiteboard 
        #whiteboard
        [currentUser]="currentUserIdentity"
        (onAction)="onWhiteboardAction($event)">
      </app-whiteboard>
    </div>

    <div class="video-container">
      <!-- Local Video -->
      <div class="video-tile local-video">
        <video #localVideo autoplay playsinline muted></video>
        <audio #localAudio autoplay></audio>
        <div class="video-label">You (Local)</div>
      </div>

      <!-- Remote Participants -->
      <div 
        class="video-tile remote-video" 
        *ngFor="let participant of connectionState.remoteParticipants"
      >
        <video 
          [id]="'remote-video-' + participant.identity" 
          autoplay 
          playsinline
        ></video>
        <audio 
          [id]="'remote-audio-' + participant.identity" 
          autoplay
        ></audio>
        <div class="video-label">{{ getParticipantDisplayName(participant.identity) }}</div>
      </div>

      <!-- No Remote Participants Message -->
      <div class="no-participants" *ngIf="connectionState.remoteParticipants.length === 0">
        <div class="waiting-message">
          <span class="material-symbols-outlined">group</span>
          <p>Waiting for others to join...</p>
          <p class="sub">Share the room name: <strong>{{ roomName }}</strong></p>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls-bar">
      <div class="left-controls">
        <span class="room-name">{{ roomName }}</span>
      </div>

      <div class="center-controls">
        <button 
          class="control-btn" 
          [class.disabled]="!isAudioEnabled"
          (click)="toggleAudio()"
          title="Toggle Microphone"
        >
          <span class="material-icons" *ngIf="isAudioEnabled">mic</span>
          <span class="material-icons" *ngIf="!isAudioEnabled">mic_off</span>
          <span class="label">Microphone</span>
        </button>

        <button 
          class="control-btn" 
          [class.disabled]="!isVideoEnabled"
          (click)="toggleVideo()"
          title="Toggle Camera"
        >
          <span class="material-icons" *ngIf="isVideoEnabled">videocam</span>
          <span class="material-icons" *ngIf="!isVideoEnabled">videocam_off</span>
          <span class="label">Camera</span>
        </button>

        <button 
          class="control-btn"
          title="Share Screen"
        >
          <span class="material-icons">present_to_all</span>
          <span class="label">Share screen</span>
        </button>

        <button 
          class="control-btn"
          title="Record"
        >
          <span class="material-icons">fiber_manual_record</span>
          <span class="label">Record</span>
        </button>

        <button 
          class="control-btn" 
          (click)="toggleWhiteboard()"
          [class.active]="showWhiteboard"
          title="Open Whiteboard"
        >
          <span class="material-icons">dashboard</span>
          <span class="label">Open whiteboard</span>
        </button>

        <button 
          class="control-btn"
          title="React"
        >
          <span class="material-icons">add_reaction</span>
          <span class="label">React</span>
        </button>

        <button 
          class="control-btn"
          title="Raise Hand"
        >
          <span class="material-icons">pan_tool</span>
          <span class="label">Raise hand</span>
        </button>

        <button 
          class="control-btn"
          title="Chat"
        >
          <span class="material-icons">chat</span>
          <span class="label">Chat</span>
        </button>

        <button 
          class="control-btn leave-btn" 
          (click)="leaveRoom()"
          title="Leave Meeting"
        >
          <span class="material-icons">call_end</span>
          <span class="label">Leave</span>
        </button>
      </div>

      <div class="right-controls">
        <!-- Empty for now, can add participant count or other info -->
      </div>
    </div>
  </div>
</div>